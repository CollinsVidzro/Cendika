


// ============================================
// CHAT MODELS (New)
// ============================================

model ChatConversation {
  id        String  @id @default(cuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  
  // Conversation Info
  type        ChatType @default(DIRECT)
  name        String?
  description String?
  avatarUrl   String?
  
  // Participants (stored in separate model)
  participantCount Int @default(0)
  
  // Last Message
  lastMessageId   String?
  lastMessageAt   DateTime?
  lastMessageText String?
  
  // Status
  isActive    Boolean @default(true)
  isArchived  Boolean @default(false)
  
  // Metadata
  metadata    Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([accountId, lastMessageAt])
  @@map("chat_conversations")
}

model ChatParticipant {
  id              String  @id @default(cuid())
  conversationId  String
  conversation    ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  // Participant
  userId      String?
  user        User? @relation(fields: [userId], references: [id])
  contactId   String?
  contact     Contact? @relation(fields: [contactId], references: [id])
  
  // External participant (no user/contact record)
  externalId    String?
  externalName  String?
  externalPhone String?
  externalEmail String?
  
  // Role
  role        String @default("member") // owner, admin, member
  
  // Status
  joinedAt    DateTime @default(now())
  leftAt      DateTime?
  isActive    Boolean @default(true)
  
  // Notification settings
  muteUntil   DateTime?
  
  @@unique([conversationId, userId])
  @@unique([conversationId, contactId])
  @@unique([conversationId, externalPhone])
  @@index([conversationId])
  @@index([userId])
  @@map("chat_participants")
}

model ChatMessage {
  id              String  @id @default(cuid())
  conversationId  String
  conversation    ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  // Sender
  senderId        String // Can be userId, contactId, or externalId
  senderType      String @default("user") // user, contact, external, system
  
  // Content
  messageType     ChatMessageType @default(TEXT)
  content         String
  attachmentUrl   String?
  attachmentType  String?
  attachmentName  String?
  
  // Status
  status          String @default("sent") // sent, delivered, read, failed
  
  // References
  replyToId       String? // Reply to another message
  forwardFromId   String? // Forwarded from another message
  
  // Metadata
  metadata        Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@index([conversationId, createdAt])
  @@index([senderId, createdAt])
  @@map("chat_messages")
}

// ============================================
// UPDATE EXISTING MODELS
// ============================================

// 1. Update Message model to support multiple message types
// Add to existing Message model:
enum MessageType {
  SMS
  OTP
  BULK
  CAMPAIGN
  EMAIL        // Add this
  WHATSAPP     // Add this  
  VOICE        // Add this
  PUSH         // Add this
}

// 2. Update Provider model for all service types
// Already has ProviderType enum with all types

// 3. Update PricingRate for all services
// Add to existing PricingRate model:
enum ServiceType {
  SMS
  OTP
  EMAIL
  VOICE
  WHATSAPP
  PUSH
  LOOKUP
  CHAT
}

// Then add serviceType field to PricingRate:
model PricingRate {
  // ... existing fields
  serviceType ServiceType @default(SMS)
  // ... rest of fields
  
  @@unique([country, network, serviceType, provider, effectiveFrom])
}

// 4. Update DailyStats for all services
model DailyStats {
  // ... existing fields
  
  // Add these:
  emailSent      Int @default(0)
  emailDelivered Int @default(0)
  emailOpened    Int @default(0)
  emailCost      Float @default(0)
  
  voiceCallsMade Int @default(0)
  voiceMinutes   Int @default(0) // Total minutes
  voiceCost      Float @default(0)
  
  whatsappSent   Int @default(0)
  whatsappDelivered Int @default(0)
  whatsappRead   Int @default(0)
  whatsappCost   Float @default(0)
  
  pushSent       Int @default(0)
  pushDelivered  Int @default(0)
  pushOpened     Int @default(0)
  pushCost       Float @default(0)
  
  lookups        Int @default(0)
  lookupCost     Float @default(0)
  
  chatMessages   Int @default(0)
  
  // ... rest of fields
}

// 5. Update Transaction for all services
// Add to existing Transaction model:
// Update TransactionType enum:
enum TransactionType {
  CREDIT
  DEBIT
  REFUND
  BONUS
  CONVERSION
  EMAIL_DEBIT       // Add this
  VOICE_DEBIT       // Add this
  WHATSAPP_DEBIT    // Add this  
  PUSH_DEBIT        // Add this
  LOOKUP_DEBIT      // Add this
  CHAT_DEBIT        // Add this
}

// Add serviceType field to Transaction:
model Transaction {
  // ... existing fields
  serviceType String? // sms, email, voice, whatsapp, push, lookup, chat
  // ... rest of fields
}